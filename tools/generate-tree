#!/usr/bin/env rc

n=10000
words='/usr/share/dict/words'
nlines=`{wc -l < $words}
dir='ports'
deps=(base 9base libc dev)

fn rnd {
	od -A n -d -N2 < /dev/urandom \
	| awk -v 'max='$1 '{print int($1 / (65536 / max))}'
}

fn rnd_word {
	awk -v 'n='`{rnd $nlines} 'NR==n {print $0; exit}' < $words \
	| tr A-Z a-z | sed 's/''s$//;s/''//g'
}

fn rnd_deps {
	n=`{awk -v 'n='`{rnd $#deps} 'BEGIN { print (n > 10) ? 10 : n; }'} {
		if (test $n -eq 0)
			echo ''
		if not {
			for (d in $deps) {
				echo $d
			}
		} | shuf | head -n $n
	}
}

fn rnd_ver {
	echo `{rnd 3}^.^`{rnd 10}^.^`{rnd 30}
}

fn mkport {
	mkdir -p $dir/$1
	port_name=$1 deps=$*(2-) ver=`{rnd_ver} {
		echo $port_name^: $port_name^'-'^$ver
		echo $port_name^'-'^$ver: $deps
		echo '  $mkpkg'
		echo '  msg download'
		echo '  check'
		echo '  msg build'
		echo '  #make DESTDIR=$pkgdir'
		echo '  #make DESTDIR=$pkgdir install'
		echo '  pack'
	} > $dir/$port_name/port.mk
	deps=($deps $1)
}

mkdir -p $dir

for (d in $deps) {
	mkport $d
}

mkport pcc `{rnd_deps}

seq $n | while (i=`{read | cat}) {
	mkport `{rnd_word} `{rnd_deps}
}
