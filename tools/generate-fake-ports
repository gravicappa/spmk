#!/usr/bin/env rc

words='/usr/share/dict/words'
nlines=`{wc -l < $words}
deps=(base 9base libc dev)

dir=$1
n=$2

if (test -z $n)
  n=100

fn rnd {
  od -A n -d -N2 < /dev/urandom \
  | awk -v 'max='$1 '{print int($1 / (65536 / max))}'
}

fn rnd_word {
  awk -v 'n='`{rnd $nlines} 'NR==n {print $0; exit}' < $words \
  | tr A-Z a-z | sed 's/''s$//;s/''//g'
}

fn rnd_deps {
  n=`{awk -v 'n='`{rnd $#deps} 'BEGIN { print (n > 5) ? 5 : n; }'} {
    {
    if (! test $n -eq 0)
      for (d in $deps)
        echo $d
    } | shuf | head -n $n
  }
}

fn rnd_ver {
  echo `{rnd 3}^.^`{rnd 10}^.^`{rnd 30}
}

fn mkport {
  mkdir -p $dir/$1
  port_name=$1 deps=$*(2-) ver=`{rnd_ver} {
    echo '# Package' $port_name 'is a dummy package.'
    echo
    echo $port_name^:V: $port_name^'-'^$ver
    echo
    echo $port_name^'-'^$ver:Q: $deps
    echo '  $header'
    echo '  msg download'
    echo '  #test -f $port_name.tar.gz \'
    echo '  #|| wget http://nosuchhost.org/$port_name.tar.gz'
    echo '  # or'
    echo '  #download http://nosuchhost.org/$port_name.tar.gz'
    echo '  verifypkg'
    echo '  #gunzip < $port_name.tar.gz | tar x'
    echo '  #cd $port_name'
    echo '  msg build'
    echo '  #make DESTDIR=$pkgdir'
    echo '  #make DESTDIR=$pkgdir install'
    echo '  msg installing fake files'
    echo '  mkdir -p $pkgdir/usr/bin $pkgdir/usr/share/$name'
    echo '  dd if=/dev/urandom of=$pkgdir/usr/share/$name/file \'
    echo '    bs='^`{rnd 16384}^' count=1 2>/dev/null'
    echo '  touch $pkgdir/usr/bin/$name'
    echo '  makepkg'
    echo
  } > $dir/$port_name/port.mk
  deps=($deps $1)
}

mkdir -p $dir

for (d in $deps)
  mkport $d

mkport pcc `{rnd_deps}

seq $n | while (i=`{read | cat})
  mkport `{rnd_word} `{rnd_deps}
