#!/usr/bin/env rc
. $spkgdir/spkgfuncs

pkg=$1
dir=$pkgdb/$pkg
name=`{echo $pkg | sed 's/-[0-9].*$//'}

filelst=`{mktemp -t spkg.filelst.XXXXXXX}

fn find_package {
	if (test -d $pkgdb/$1) 
		echo $1
	if not {
		dep=$pkgdb/$1'-'*
		if (test -d $dep(1))
			echo $dep(1)
	}
}

{
	while (dep=`{read})
		if (test $#dep -gt 0) {
			p=`{find_package $dep}
			if (test $#p -gt 0 && test -f $p/required_by) {
			  {
					echo 'g/^'$pkg'$/d'
					echo 'g/^'$name'$/d'
					echo w
					echo q
				} | ed $p/required_by >[2]/dev/null
			}
		}
} < $dir/deps
cat < $dir/files > $filelst
if (test -x $dir/install)
	$dir/install remove
rm -r $dir
remove_files $root $filelst
true
